<!DOCTYPE html>
<html lang="en-US">
	<head>
    	<meta charset="utf-8">
    	<style type="text/css">
      		html, body {
        	overflow:hidden;
      		}
      	  circle {
        	stroke: #555;
        	stroke-width: 1px;
        	opacity: 0.8;
      		}
      	  circle:hover {
        	stroke:#000;
        	opacity:0.9;
      		}
      	  .btn-group {
        	margin-left: 330px;
      		}
      	  .label {
        	font-size: 20px;
      		}
      	  .color-legend {
        	min-height: 100%; 
        	min-height: 100vh;
       	   	display: flex;
        	align-items: center;
        	height:34px; 
			font-weight:bold; 
			text-align:center; 
			color:white;
        	text-shadow: 2px 2px #333;
      		}
    	</style>
    	<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
	</head>
	<body>
		<div class="row">
			<div class="dropdowns">
				<div class="col-xs-2">
	    			Year:
	      			<select class="form-control" name="board" id="board">
						<option value="2014">2014</option>
						<option value="2013">2013</option>
						<option value="2012">2012</option>
						<option value="2011">2011</option>
						<option value="2010">2010</option>
	        			<option value="2009">2009</option>
						<option value="2008">2008</option>
						<option value="Total">All Years</option>
	      			</select>
	    		</div>
		
				<div class="col-xs-2"></div>

  				<div class="col-xs-2">
  	  				Size By:
	  				<select class="form-control" name="size" id="size">
		  				<option value="log_val">Value</option>
						<option value="log_quant">Quantity</option>
	  				</select>
  				</div>
			</div>
		</div>
	
		<div id="chart"></div>
		<script src="js/d3.v3.min.js"></script>
		<script src="js/jsonp.js"></script>
		<script src="js/jquery-2.1.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/underscore.min.js"></script>
		<script>
	  var group = '';
	  var size = 'log_val'
	  var color = 'broad_code';
      start('2014');

      function start(year) {
        $.ajax({
            'url': year + "_data.json",
            'dataType': 'json',
            'responseJSON': 'data',
            'success': function (data) {
              create(data);
            }
        });
      }
      
      function create(data) {
        var colors = {
			broad_code: {
				c04: '#F3F781',
				c06: '#81F781',
				c07: '#D8F781',
				c08: '#A9F5BC',
				c09: '#795F56',
				c10: '#81F7D8',
				c11: '#F78181',
				c12: '#8CCEAE',
				c15: '#81BEF7',
				c17: '#819FF7',
				c18: '#8181F7',
				c19: '#9F81F7',
				c20: '#F781D8',
				c21: '#DA81F5',
				c22: '#A9F5F2',
				c24: '#BE81F7',
				c33: '#F781BE',
				c35: '#D8D8D8',
				c38: '#2E2E2E',
				c41: '#FFB875',
				c51: '#F7BE81',
				c52: '#F5DA81'
			},
			quant_cat: {
				Less100: '#7075FF',
				Bet100_1K: '#B8CAFF',
				Bet1K_10K: '#B7F1FF',
				Bet10K_100K: '#AFFFA2',
				Bet100K_500K: '#FEFFA2',
				Bet500K_1M: '#E7B7FF',
				More1M: '#FFC178'
          	},
			val_cat: {
				Less100: '#7075FF',
				Bet100_1K: '#B8CAFF',
				Bet1K_10K: '#B7F1FF',
				Bet10K_100K: '#AFFFA2',
				Bet100K_500K: '#FEFFA2',
				Bet500K_1M: '#E7B7FF',
				More1M: '#FFC178'
          	},
          	default: '#DFF8FF'
        };

        var radius = 75;
        var width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        var fill = d3.scale.ordinal().range(['#FF00CC','#FF00CC','#00FF00','#00FF00','#FFFF00','#FF0000','#FF0000','#FF0000','#FF0000','#7F0000']);
        var svg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height);

        data = getDataMapping(data, size);

        var padding = 2;
        var maxRadius = d3.max(_.pluck(data, 'radius'));

        var maximums = {
          Time: d3.max(_.pluck(data, 'exp')),
          Age: d3.max(_.pluck(data, 'str'))
        };

        var getCenters = function (vname, size) {
          var centers, map;
          centers = _.uniq(_.pluck(data, vname)).map(function (d) {
            return {name: d, value: 1};
          });
          
          map = d3.layout.treemap().size(size).ratio(1/1);
          map.nodes({children: centers});

          return centers;
        };

        var nodes = svg.selectAll("circle")
          .data(data);

        nodes.enter().append("circle")
          .attr("class", "node")
          .attr("cx", function (d) { return d.x; })
          .attr("cy", function (d) { return d.x; })
          .attr("r", function (d) { return d.radius; })
          .style("fill", function (d, i) { return colors['default']; })
          .on("mouseover", function (d) { showPopover.call(this, d); })
          .on("mouseout", function (d) { removePopovers(); });

        function getDataMapping(data, vname) {
          var max = d3.max(_.pluck(data, vname));
          
          for (var j = 0; j < data.length; j++) {
            data[j].radius = (vname != '') ? radius * (data[j][vname] / max) : 15;
            data[j].x = data[j].x ? data[j].x : Math.random() * width;
            data[j].y = data[j].y ? data[j].y : Math.random() * height;
          }
          return data;
        }
		
        $('#board').change(function() {
          $('#chart').empty();
          start(this.value);
        });

        $('#group').change(function() {
          	group = this.value;
          	draw(group);
        });

        $('#size').change(function() {
          var val = this.value;
          var max = d3.max(_.pluck(data, val));

          d3.selectAll("circle")
            .data(getDataMapping(data, this.value))
            .transition()
            .attr('r', function(d, i) { return val ? (radius * (data[i][val] / max)) : 15 })
            .attr('cx', function(d) { return d.x })
            .attr('cy', function(d) { return d.y })
            .duration(500);

          size = this.value;
          force.start();
        });
		
        $('#color').change(function() {
          color = this.value;
          changeColor(this.value);
        });
        
        function changeColor(val) {
          console.log(val);
          d3.selectAll("circle")
            .transition()
            .style('fill', function(d) { return val ? colors[val][d[val]] : colors['default'] })
            .duration(1000);

          $('.colors').empty();
          if(val) {
            for(var label in colors[val]) {
              $('.colors').append('<div class="col-xs-1 color-legend" style="background:'+colors[val][label]+';">'+label+'</div>')
            }
          }
        }
        
        var force = d3.layout.force();
        changeColor(color);
        draw(group);

        function draw (varname) {
          var centers = getCenters(varname, [width, height]);
          force.on("tick", tick(centers, varname));
          labels(centers)
          force.start();
        }

        function tick (centers, varname) {
          var foci = {};
          for (var i = 0; i < centers.length; i++) {
            foci[centers[i].name] = centers[i];
          }
          return function (e) {
            for (var i = 0; i < data.length; i++) {
              var o = data[i];
              var f = foci[o[varname]];
              o.y += ((f.y + (f.dy / 2)) - o.y) * e.alpha * 0.4;
              o.x += ((f.x + (f.dx / 2)) - o.x) * e.alpha * 0.4;
            }
            nodes.each(collide(0.2))
              .attr("cx", function (d) { return d.x; })
              .attr("cy", function (d) { return d.y; });
          }
        }

        function labels (centers) {
          svg.selectAll(".label").remove();
          svg.selectAll(".label")
          .data(centers).enter().append("text")
          .attr("class", "label")
          .text(function (d) { return d.name })
          .attr("transform", function (d) {
            return "translate(" + (d.x + (d.dx / 2) - 100) + ", " + (d.y + 20) + ")";
          });
        }

        function removePopovers () {
          $('.popover').each(function() {
            $(this).remove();
          }); 
        }
		
		Number.prototype.formatMoney = function(c, d, t) {
		var n = this, 
		    c = isNaN(c = Math.abs(c)) ? 2 : c, 
		    d = d == undefined ? "." : d, 
		    t = t == undefined ? "," : t, 
		    s = n < 0 ? "-" : "", 
		    i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
		    j = (j = i.length) > 3 ? j % 3 : 0;
		   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
		 };
		
        function showPopover (d) {
          $(this).popover({
            placement: 'auto top',
            container: 'body',
            trigger: 'manual',
            html : true,
            content: function() { 
              return "<h5>" + d.fine_cat + "</h4><br />" +
              "<strong>Category: </strong>" + d.broad_cat + "<br />" +
              "<strong>Code: </strong>" + d.code + "<br />" +
			  "<strong>Year: </strong>" + d.year + "<br />" +
              "<strong>Quantity (tons): </strong>" + d.quantity.formatMoney(0) + "<br />" +
			  "<strong>Value:</strong> â‚¬" + d.value.formatMoney(0);
            }
          });
          $(this).popover('show')
        }

        function collide(alpha) {
          var quadtree = d3.geom.quadtree(data);
          return function (d) {
            var r = d.radius + maxRadius + padding,
                nx1 = d.x - r,
                nx2 = d.x + r,
                ny1 = d.y - r,
                ny2 = d.y + r;
            quadtree.visit(function(quad, x1, y1, x2, y2) {
              if (quad.point && (quad.point !== d)) {
                var x = d.x - quad.point.x,
                    y = d.y - quad.point.y,
                    l = Math.sqrt(x * x + y * y),
                    r = d.radius + quad.point.radius + padding;
                if (l < r) {
                  l = (l - r) / l * alpha;
                  d.x -= x *= l;
                  d.y -= y *= l;
                  quad.point.x += x;
                  quad.point.y += y;
                }
              }
              return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
            });
          };
        }
	}
	</script>
	</body>
</html>